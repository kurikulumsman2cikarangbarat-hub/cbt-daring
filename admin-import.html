<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT - Upload Soal Ke Database</title>
    <style>
        /* Style Dasar */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 1.8rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e9ecef;
        }
        
        .section-title {
            color: #1a73e8;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .btn {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.3);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
        }

        .info-box {
            background: #e8f0fe;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }

        .token-status {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
            display: none;
        }
        
        .token-valid { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .token-invalid { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .progress-container { margin: 20px 0; display: none; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #1a73e8, #27ae60); width: 0%; transition: width 0.5s ease; }
        
        .soal-preview { margin-top: 20px; max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: white; }
        .soal-item { padding: 10px; margin-bottom: 10px; border-left: 4px solid #dee2e6; background: #f8f9fa; border-radius: 0 8px 8px 0; }
        .soal-item.error { border-left-color: #e74c3c; background: #fdedec; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        
        .modal-content { background: white; border-radius: 15px; padding: 30px; width: 90%; max-width: 500px; }

        .loading {
            display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3;
            border-top: 3px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-top: 4px solid #1a73e8; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: #1a73e8; }
        .stat-label { font-size: 0.85rem; color: #666; margin-top: 5px; }

        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .action-buttons button { flex: 1; }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    
    <div class="container" id="main-container">
        <div class="header">
            <h1><i class="fas fa-upload"></i> CBT - Upload Soal ke Database</h1>
            <p>SMAN 2 Cikarang Barat - Sistem Computer Based Test</p>
        </div>
        
        <div class="content" id="main-content">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-file-alt"></i> Informasi Ujian
                </div>
                
                <div class="input-group">
                    <label for="input-token"><i class="fas fa-key"></i> Token Ujian *</label>
                    <input type="text" id="input-token" placeholder="Contoh: MATEMATIKA-2024" maxlength="50">
                    <div id="token-status" class="token-status"></div>
                </div>
                
                <div class="input-group">
                    <label for="input-mapel"><i class="fas fa-book"></i> Mata Pelajaran *</label>
                    <input type="text" id="input-mapel" placeholder="Contoh: Matematika, Bahasa Indonesia, dll">
                </div>
                
                <div class="input-group">
                    <label for="input-guru"><i class="fas fa-chalkboard-teacher"></i> Nama Guru *</label>
                    <input type="text" id="input-guru" placeholder="Nama lengkap guru pengampu">
                </div>
                
                <div class="input-group">
                    <label for="input-durasi"><i class="fas fa-clock"></i> Durasi Ujian (menit) *</label>
                    <input type="number" id="input-durasi" min="1" max="300" value="60">
                </div>
                
                <div class="input-group">
                    <label for="input-aktif"><i class="fas fa-toggle-on"></i> Status Ujian</label>
                    <select id="input-aktif">
                        <option value="1">Aktif (Siswa bisa mengikuti)</option>
                        <option value="0">Nonaktif (Hanya untuk testing)</option>
                    </select>
                </div>
                
                <div class="action-buttons">
                    <button id="btn-check-token" class="btn btn-secondary" onclick="checkTokenUjian()">
                        <i class="fas fa-search"></i> Cek Token Ujian
                    </button>
                    
                    <button id="btn-verify-token" class="btn btn-success" onclick="verifyToken()" disabled>
                        <i class="fas fa-check-circle"></i> Gunakan Token
                    </button>
                </div>
            </div>
            
            <div class="section" id="soal-section" style="display: none;">
                <div class="section-title">
                    <i class="fas fa-question-circle"></i> Upload Soal
                </div>
                
                <div class="warning-box">
                    <p><strong>Format Excel:</strong> Soal [TAB] A [TAB] B [TAB] C [TAB] D [TAB] E [TAB] Kunci [TAB] Gambar</p>
                </div>
                
                <div class="input-group">
                    <label for="input-soal"><i class="fas fa-paste"></i> Paste Soal dari Excel *</label>
                    <textarea id="input-soal" placeholder="Paste data soal dari Excel di sini..."></textarea>
                </div>

                <div class="progress-container" id="progress-container">
                    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                    <div id="progress-text" style="text-align:center; font-size:0.8rem;">Menyiapkan...</div>
                </div>
                
                <button id="btn-upload" class="btn btn-success" onclick="uploadData()">
                    <i class="fas fa-cloud-upload-alt"></i> Upload Soal ke Database
                </button>
                
                <div class="soal-preview" id="soal-preview"></div>
            </div>
        </div>
        
        <div class="content" style="grid-template-columns: 1fr; display: none;" id="results-section">
            <div class="section">
                <div class="section-title"><i class="fas fa-chart-bar"></i> Hasil Upload</div>
                <div id="results-container"></div>
                <div class="stats" id="stats-container"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="backToUpload()">Kembali</button>
                    <button class="btn btn-success" onclick="openNewUjian()">Ujian Baru</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loading-modal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div class="loading" style="width: 40px; height: 40px; margin-bottom: 15px;"></div>
            <p id="loading-message">Memproses...</p>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION (WAJIB DIISI)
        // ==========================================
        const API_URL = 'https://worker-abk.kurikulum-sman2cikarangbarat.workers.dev';
        const adminToken = '@SMAN2Cikbar'; // <--- MASUKKAN TOKEN ADMIN ANDA DI SINI
        // ==========================================

        let currentToken = '';
        let existingUjianData = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('input-soal').addEventListener('input', previewSoal);
        });

        async function checkTokenUjian() {
            const token = document.getElementById('input-token').value.trim();
            const statusBox = document.getElementById('token-status');
            if (!token) return;

            const btn = document.getElementById('btn-check-token');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>';

            try {
                const res = await fetch(`${API_URL}/api/check-token?token=${encodeURIComponent(token)}`);
                const data = await res.json();
                
                if (data.exists) {
                    const ujianRes = await fetch(`${API_URL}/api/ujian?token=${encodeURIComponent(token)}`);
                    const ujianData = await ujianRes.json();
                    existingUjianData = ujianData.data;
                    statusBox.textContent = "⚠ Token sudah ada. Data akan diperbarui.";
                    statusBox.className = "token-status token-invalid";
                } else {
                    existingUjianData = null;
                    statusBox.textContent = "✅ Token tersedia.";
                    statusBox.className = "token-status token-valid";
                }
                statusBox.style.display = 'block';
                document.getElementById('btn-verify-token').disabled = false;
                currentToken = token;
            } catch (e) {
                alert("Gagal koneksi ke server.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Cek Token Ujian';
            }
        }

        function verifyToken() {
            document.getElementById('soal-section').style.display = 'block';
            if (existingUjianData) {
                document.getElementById('input-mapel').value = existingUjianData.mapel;
                document.getElementById('input-guru').value = existingUjianData.nama_guru;
                document.getElementById('input-durasi').value = existingUjianData.durasi;
            }
            document.getElementById('soal-section').scrollIntoView({ behavior: 'smooth' });
        }

        function previewSoal() {
            const text = document.getElementById('input-soal').value.trim();
            const preview = document.getElementById('soal-preview');
            if (!text) { preview.innerHTML = ''; return; }
            const lines = text.split('\n').filter(l => l.trim());
            preview.innerHTML = `<p><strong>${lines.length} soal terdeteksi.</strong></p>`;
        }

        async function uploadData() {
            const mapel = document.getElementById('input-mapel').value.trim();
            const guru = document.getElementById('input-guru').value.trim();
            const durasi = document.getElementById('input-durasi').value;
            const soalText = document.getElementById('input-soal').value.trim();

            if (!mapel || !guru || !soalText) { alert("Lengkapi data!"); return; }

            const lines = soalText.split('\n').filter(l => l.trim());
            if (!confirm(`Upload ${lines.length} soal?`)) return;

            document.getElementById('loading-modal').style.display = 'flex';
            
            try {
                // 1. Create/Update Ujian
                const resUjian = await fetch(`${API_URL}/api/admin/ujian`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
                    body: JSON.stringify({
                        token: currentToken, mapel, nama_guru: guru,
                        durasi: parseInt(durasi), aktif: document.getElementById('input-aktif').value
                    })
                });

                if (!resUjian.ok) throw new Error("Gagal update data ujian.");

                // 2. Upload Soal (Batching)
                let successCount = 0;
                document.getElementById('progress-container').style.display = 'block';

                for (let i = 0; i < lines.length; i++) {
                    const parts = lines[i].split('\t');
                    if (parts.length < 7) continue;

                    const soalObj = {
                        token: currentToken, soal: parts[0], opsi_a: parts[1],
                        opsi_b: parts[2], opsi_c: parts[3], opsi_d: parts[4],
                        opsi_e: parts[5] || '', kunci: parts[6].trim().toUpperCase(),
                        img_link: parts[7] || null, aktif: "1"
                    };

                    const resSoal = await fetch(`${API_URL}/api/admin/soal`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken },
                        body: JSON.stringify(soalObj)
                    });

                    if (resSoal.ok) successCount++;
                    
                    let pc = Math.round(((i + 1) / lines.length) * 100);
                    document.getElementById('progress-fill').style.width = pc + '%';
                    document.getElementById('progress-text').textContent = `Mengupload ${i+1}/${lines.length}`;
                }

                showFinalResults(successCount, lines.length);
            } catch (e) {
                alert(e.message);
            } finally {
                document.getElementById('loading-modal').style.display = 'none';
            }
        }

        function showFinalResults(success, total) {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('results-section').style.display = 'grid';
            document.getElementById('results-container').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${success}/${total}</div>
                    <div class="stat-label">Soal Berhasil Diupload</div>
                </div>
            `;
        }

        function backToUpload() {
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'grid';
        }

        function openNewUjian() {
            location.reload();
        }
    </script>
</body>
</html>
