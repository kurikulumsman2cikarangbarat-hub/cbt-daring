<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT - Upload Soal Ke Database</title>
    <style>
        /* Style Dasar */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 24px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e0e0e0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .grid-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary { background: #1a73e8; color: white; width: 100%; justify-content: center; }
        .btn-primary:hover { background: #1557b0; transform: translateY(-2px); }

        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }

        .btn-success { background: #28a745; color: white; width: 100%; justify-content: center; margin-top: 20px; }
        .btn-success:hover { background: #218838; }

        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        .file-upload-wrapper {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-wrapper:hover {
            border-color: #1a73e8;
            background: #f1f7ff;
        }

        .file-upload-wrapper i {
            font-size: 40px;
            color: #1a73e8;
            margin-bottom: 10px;
        }

        #file-info {
            margin-top: 15px;
            font-size: 14px;
            color: #28a745;
            display: none;
            font-weight: 600;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a73e8;
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }

        #loading-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
            gap: 15px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .results-section {
            display: none;
            padding: 30px;
            text-align: center;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }

        .stat-value { font-size: 24px; font-weight: 700; color: #1a73e8; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }

        .helper-text {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 14px;
            border: 1px solid #ffeeba;
        }
    </style>
</head>
<body>

    <div id="loading-modal">
        <div class="spinner"></div>
        <div id="progress-text">Menyiapkan data...</div>
        <div style="width: 300px; margin-top: 10px;">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>CBT ADMIN - DATABASE UPLOADER</h1>
            <p>Sistem Pengelola Bank Soal SMAN 2 Cikarang Barat</p>
        </div>

        <div id="main-content" class="main-grid">
            <div class="card">
                <div class="card-title">üìù Detail Ujian</div>
                
                <div class="grid-form">
                    <div class="form-group">
                        <label>Mata Pelajaran</label>
                        <input type="text" id="mapel" placeholder="Contoh: Matematika">
                    </div>
                    <div class="form-group">
                        <label>Nama Guru</label>
                        <input type="text" id="nama_guru" placeholder="Nama Lengkap & Gelar">
                    </div>
                    <div class="form-group">
                        <label>Durasi (Menit)</label>
                        <input type="number" id="durasi" placeholder="Contoh: 90">
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah Soal Diujikan</label>
                        <input type="number" id="jml_soal" placeholder="Contoh: 40">
                        <small style="color: #666; font-size: 11px;">Kosongkan jika semua soal.</small>
                    </div>

                    <div class="form-group" style="grid-column: span 2;">
                        <label>Token Ujian (Manual/Otomatis)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="token" placeholder="Contoh: MAT01" style="flex: 1;">
                            <button class="btn btn-secondary" onclick="generateToken()">Acak</button>
                        </div>
                    </div>
                </div>

                <div class="helper-text" style="margin-top: 20px;">
                    <strong>Tips:</strong> Pastikan token unik dan mudah diingat oleh siswa. Token akan digunakan untuk mengakses soal.
                </div>
            </div>

            <div class="card">
                <div class="card-title">üì§ Upload Data Soal</div>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    Gunakan format baris: <br>
                    <code>Soal | A | B | C | D | E | Kunci | Link_Gambar</code>
                </p>

                <div class="file-upload-wrapper" onclick="document.getElementById('excelFile').click()">
                    <i>üìÅ</i>
                    <p>Klik untuk pilih file teks/excel soal</p>
                    <input type="file" id="excelFile" hidden accept=".txt,.csv">
                    <div id="file-info"></div>
                </div>

                <button class="btn btn-success" id="btn-upload" onclick="saveUjian()">
                    MULAI IMPORT KE DATABASE
                </button>
            </div>
        </div>

        <div id="results-section" class="results-section">
            <h2 style="color: #28a745;">‚úÖ Berhasil Diupload!</h2>
            <div id="results-container" class="stat-grid"></div>
            
            <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-primary" onclick="openNewUjian()" style="width: auto;">Buat Ujian Baru</button>
                <button class="btn btn-secondary" onclick="backToUpload()">Edit Data Terakhir</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://ujian-baru.kurikulum-sman2cikarangbarat.workers.dev/";
        let currentUjianToken = "";
        let rawData = "";

        // File Selection Listener
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    rawData = e.target.result;
                    document.getElementById('file-info').innerText = `üìÑ ${file.name} (${rawData.split('\n').length} baris)`;
                    document.getElementById('file-info').style.display = 'block';
                };
                reader.readAsText(file);
            }
        });

        function generateToken() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 5; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('token').value = result;
        }

        async function saveUjian() {
            const mapel = document.getElementById('mapel').value;
            const guru = document.getElementById('nama_guru').value;
            const durasi = document.getElementById('durasi').value;
            const token = document.getElementById('token').value;
            const jmlSoal = document.getElementById('jml_soal').value; // Penambahan

            if (!mapel || !guru || !durasi || !token) {
                alert('Mohon lengkapi semua data ujian!');
                return;
            }

            if (!rawData) {
                alert('Pilih file soal terlebih dahulu!');
                return;
            }

            const adminToken = localStorage.getItem('adminToken') || prompt('Masukkan Admin Token:');
            if (!adminToken) return;
            localStorage.setItem('adminToken', adminToken);

            document.getElementById('loading-modal').style.display = 'flex';
            document.getElementById('progress-text').textContent = "Membuat sesi ujian...";

            try {
                // Step 1: Simpan detail ujian
                const resUjian = await fetch(API_URL + 'api/admin/ujian', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Token': adminToken
                    },
                    body: JSON.stringify({
                        token: token,
                        mapel: mapel,
                        nama_guru: guru,
                        durasi: parseInt(durasi),
                        jml_soal: jmlSoal ? parseInt(jmlSoal) : 0, // Penambahan terintegrasi
                        aktif: 1
                    })
                });

                const dataUjian = await resUjian.json();
                if (!dataUjian.success) throw new Error(dataUjian.error);

                currentUjianToken = token;
                await processSoal(adminToken);

            } catch (e) {
                alert('Gagal: ' + e.message);
                document.getElementById('loading-modal').style.display = 'none';
            }
        }

        async function processSoal(adminToken) {
            const lines = rawData.split('\n').filter(line => line.trim().includes('|'));
            let successCount = 0;

            try {
                for (let i = 0; i < lines.length; i++) {
                    const parts = lines[i].split('|').map(p => p.trim());
                    if (parts.length < 7) continue;

                    const soalObj = {
                        token: currentUjianToken,
                        soal: parts[0],
                        opsi_a: parts[1],
                        opsi_b: parts[2],
                        opsi_c: parts[3],
                        opsi_d: parts[4],
                        opsi_e: parts[5],
                        kunci: parts[6],
                        img_link: parts[7] || "",
                        aktif: 1
                    };

                    const resSoal = await fetch(API_URL + 'api/admin/soal', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Admin-Token': adminToken
                        },
                        body: JSON.stringify(soalObj)
                    });

                    if (resSoal.ok) successCount++;
                    
                    let pc = Math.round(((i + 1) / lines.length) * 100);
                    document.getElementById('progress-fill').style.width = pc + '%';
                    document.getElementById('progress-text').textContent = `Mengupload ${i+1}/${lines.length}`;
                }

                showFinalResults(successCount, lines.length);
            } catch (e) {
                alert(e.message);
            } finally {
                document.getElementById('loading-modal').style.display = 'none';
            }
        }

        function showFinalResults(success, total) {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';
            document.getElementById('results-container').innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${success}/${total}</div>
                    <div class="stat-label">Soal Berhasil Diupload</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${document.getElementById('token').value}</div>
                    <div class="stat-label">Token Ujian Aktif</div>
                </div>
            `;
        }

        function backToUpload() {
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('main-content').style.display = 'grid';
        }

        function openNewUjian() {
            location.reload();
        }
    </script>
</body>
</html>
