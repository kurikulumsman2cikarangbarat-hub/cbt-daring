<!DOCTYPE html>
<html>
<head>
  <title>Debug Database Worker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .error { color: red; background: #ffe6e6; padding: 10px; border: 1px solid red; }
    .success { color: green; background: #e6ffe6; padding: 10px; border: 1px solid green; }
  </style>
</head>
<body>
  <h2>üîß Debug Database Worker</h2>
  
  <button onclick="testEndpoints()">1. Test Semua Endpoint</button>
  <button onclick="checkDB()">2. Cek Database (Main)</button>
  
  <div id="result"></div>
  
  <script>
    const API_URL = "https://worker-abk.kurikulum-sman2cikarangbarat.workers.dev";
    const ADMIN_TOKEN = "DwiW1980"; // Pastikan token ini benar
    
    // =============== FUNGSI 1: TEST SEMUA ENDPOINT ===============
    async function testEndpoints() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = "<div class='success'>üîç Testing semua endpoint...</div>";
      
      const endpoints = [
        '/api/debug/tables',
        '/api/tables',
        '/debug/tables',
        '/admin/tables',
        '/db/tables',
        '/api/db/tables',
        '/',
        '/api/health',
        '/api/status',
        '/debug',
        '/admin'
      ];
      
      let html = '<h3>üìã Hasil Test Endpoint:</h3>';
      html += '<p>Mencoba endpoint dengan header: <code>X-Admin-Token: ' + ADMIN_TOKEN + '</code></p>';
      html += '<table>';
      html += '<tr><th>No</th><th>Endpoint</th><th>Status</th><th>Response Singkat</th></tr>';
      
      for (let i = 0; i < endpoints.length; i++) {
        const endpoint = endpoints[i];
        const fullUrl = API_URL + endpoint;
        
        html += `<tr>
          <td>${i + 1}</td>
          <td><code><a href="${fullUrl}" target="_blank">${endpoint}</a></code></td>`;
        
        try {
          console.log(`üîÑ Mencoba: ${fullUrl}`);
          const resp = await fetch(fullUrl, {
            headers: { 'X-Admin-Token': ADMIN_TOKEN }
          });
          
          const status = resp.status;
          const statusText = resp.statusText;
          const text = await resp.text();
          
          const statusColor = status === 200 ? 'green' : status === 404 ? 'orange' : 'red';
          
          html += `<td><span style="color: ${statusColor}; font-weight: bold">${status} ${statusText}</span></td>
            <td><div style="max-height: 60px; overflow: auto; font-size: 12px;">${escapeHtml(text.substring(0, 150))}</div></td>`;
          
          console.log(`   ‚Ü≥ ${status} ${statusText}: "${text.substring(0, 50)}..."`);
          
        } catch (e) {
          html += `<td><span style="color: red; font-weight: bold">ERROR</span></td>
            <td>${e.message}</td>`;
          console.log(`   ‚Ü≥ ERROR: ${e.message}`);
        }
        
        html += '</tr>';
      }
      
      html += '</table>';
      html += '<p><strong>üìù Instruksi:</strong> Lihat Console (F12) untuk detail lengkap.</p>';
      
      resultDiv.innerHTML = html;
    }
    
    // =============== FUNGSI 2: CEK DATABASE UTAMA ===============
    async function checkDB() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = "<div class='success'>‚è≥ Mengakses /api/debug/tables...</div>";
      
      try {
        const response = await fetch(API_URL + '/api/debug/tables', {
          headers: { 
            'X-Admin-Token': ADMIN_TOKEN,
            'Accept': 'application/json'
          }
        });
        
        const rawText = await response.text();
        console.log("üì¶ Raw Response:", rawText);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        let data;
        try {
          data = JSON.parse(rawText);
        } catch (e) {
          throw new Error(`Bukan JSON! Response: "${rawText.substring(0, 100)}..."`);
        }
        
        // Jika berhasil parse JSON
        if (data.error) {
          throw new Error(`Server error: ${data.error}`);
        }
        
        if (!data.tables || data.tables.length === 0) {
          resultDiv.innerHTML = "<div class='success'>‚úÖ Berhasil terhubung. Database tidak memiliki tabel.</div>";
          return;
        }
        
        let html = '<div class="success">‚úÖ Berhasil mengambil data database!</div>';
        html += '<h3>üìä Struktur Database:</h3>';
        
        for (const table of data.tables) {
          html += `<h4>üìë Tabel: <code>${table.name}</code></h4>`;
          html += '<table>';
          html += '<tr><th>CID</th><th>Nama Kolom</th><th>Tipe Data</th><th>Not Null</th><th>PK</th><th>Default</th></tr>';
          
          const cols = data.structures?.[table.name] || [];
          cols.forEach(col => {
            html += `<tr>
              <td>${col.cid}</td>
              <td><strong>${col.name}</strong></td>
              <td><code>${col.type}</code></td>
              <td>${col.notnull ? '‚úÖ' : '‚ùå'}</td>
              <td>${col.pk ? '‚úÖ' : ''}</td>
              <td><small>${col.dflt_value || '(null)'}</small></td>
            </tr>`;
          });
          html += '</table><br>';
        }
        
        resultDiv.innerHTML = html;
        
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <h3>‚ùå Gagal Mengakses Database</h3>
            <p><strong>${error.message}</strong></p>
            <hr>
            <p><strong>Langkah selanjutnya:</strong></p>
            <ol>
              <li>Klik tombol <strong>"1. Test Semua Endpoint"</strong> untuk mencari endpoint yang tersedia</li>
              <li>Pastikan token admin benar: <code>${ADMIN_TOKEN}</code></li>
              <li>Cek Cloudflare Workers Dashboard untuk melihat route yang ada</li>
              <li>Endpoint <code>/api/debug/tables</code> mungkin belum diimplementasikan</li>
            </ol>
          </div>
        `;
      }
    }
    
    // Helper function
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
