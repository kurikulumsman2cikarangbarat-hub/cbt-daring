<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin CBT - Login & Input Soal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ff9800;
            --danger: #e74c3c;
            --bg: #f4f7f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login Style */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Panel Admin Style */
        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            display: none; /* Hidden before login */
            margin-top: auto;
            margin-bottom: auto;
        }

        .header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .content-padding { padding: 30px; }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus { border-color: var(--primary); outline: none; }
        textarea { height: 250px; resize: vertical; font-family: 'Courier New', monospace; }

        .btn {
            background: var(--primary); color: white; border: none;
            padding: 15px 25px; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 16px; transition: 0.3s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); }
        .btn-danger { background: var(--danger); }
        .btn-info { background: #17a2b8; }
        .btn-block { width: 100%; margin-top: 10px; }

        .token-display {
            background: #e8f0fe; padding: 15px; border-radius: 8px;
            text-align: center; margin-bottom: 20px; border: 2px dashed var(--primary);
        }

        #loading-modal {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000;
            justify-content: center; align-items: center; color: white; flex-direction: column;
        }

        .progress-container { width: 300px; background: #444; height: 10px; border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .progress-fill { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; }

        .notification { padding: 12px; border-radius: 8px; margin: 10px 0; display: flex; align-items: center; gap: 10px; }
        .notification-error { background: #f8d7da; color: #721c24; border-left: 4px solid var(--danger); }
        
        .advanced-settings {
            margin-top: 30px; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 10px; 
            border: 1px solid #dee2e6;
        }
        
        .info-box {
            margin-top: 20px; 
            padding: 15px; 
            background: #e8f4fd; 
            border-radius: 8px; 
            border-left: 4px solid #17a2b8;
        }
        
        .status-indicator {
            margin-top: 8px; 
            padding: 8px; 
            border-radius: 5px; 
            display: none;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <i class="fas fa-user-shield fa-4x" style="color: var(--primary); margin-bottom: 20px;"></i>
            <h2>Admin Login</h2>
            <p style="color: #666; margin-bottom: 25px;">Masukkan token admin untuk mengelola ujian</p>
            <div class="input-group">
                <input type="password" id="admin-password" placeholder="Admin Token / Password" style="text-align: center;">
            </div>
            <button class="btn btn-block" onclick="attemptLogin()">Login <i class="fas fa-sign-in-alt"></i></button>
            <div id="login-notif"></div>
        </div>
    </div>

    <div class="container" id="admin-panel">
        <div class="header">
            <h1><i class="fas fa-database"></i> Panel Kontrol Ujian</h1>
            <button onclick="logout()" style="position: absolute; right: 20px; top: 20px; background: rgba(0,0,0,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                Logout <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>

        <div id="setup-step" class="content-padding">
            <h3><i class="fas fa-edit"></i> Pilih Token Ujian</h3>
            <div style="display: flex; gap: 10px; margin: 15px 0;">
                <input type="text" id="input-token" placeholder="Contoh: MTK2024" style="text-transform: uppercase;">
                <button class="btn btn-warning" onclick="loadExistingData()">Edit Ujian</button>
                <button class="btn btn-success" onclick="createNewExam()">Buat Baru</button>
            </div>
            <div id="action-notif"></div>
        </div>

        <div id="main-content" class="content-padding" style="display: none;">
            <div class="token-display">
                <small>TOKEN UJIAN AKTIF</small>
                <h2 id="display-token">-</h2>
                <p id="mode-text" style="font-size: 0.8em; color: #666;"></p>
            </div>

            <div class="form-grid">
                <div class="input-group"><label>Mata Pelajaran</label><input type="text" id="input-mapel"></div>
                <div class="input-group"><label>Nama Guru</label><input type="text" id="input-guru"></div>
                <div class="input-group"><label>Durasi (Menit)</label><input type="number" id="input-durasi" value="90"></div>
                <div class="input-group"><label>Jumlah Soal Tampil</label><input type="number" id="input-jml-soal"></div>
            </div>

            <div class="input-group">
                <label>Input Soal (TAB Separated)</label>
                <textarea id="input-soal" placeholder="Paste data Excel di sini..." oninput="updateSoalCount()"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <small>Format: Soal [TAB] A [TAB] B [TAB] C [TAB] D [TAB] E [TAB] Kunci [TAB] Gambar</small>
                    <small id="soal-count" style="font-weight: bold; color: var(--primary);">0 soal</small>
                </div>
            </div>

            <!-- Pengaturan Lanjutan -->
            <div class="advanced-settings">
                <h4><i class="fas fa-cog"></i> Pengaturan Lanjutan</h4>
                
                <div class="form-grid" style="margin-top: 15px;">
                    <div class="input-group">
                        <label>Ubah Token Ujian</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="new-token" placeholder="Token baru" style="flex: 1;">
                            <button class="btn btn-warning" onclick="updateToken()" style="white-space: nowrap;">
                                <i class="fas fa-exchange-alt"></i> Ubah Token
                            </button>
                        </div>
                        <small style="color: #666;">Token lama: <span id="current-token-display">-</span></small>
                    </div>
                    
                    <div class="input-group">
                        <label>Status Ujian</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="ujian-status" style="flex: 1;">
                                <option value="1">Aktif (Siswa bisa ujian)</option>
                                <option value="0">Nonaktif (Tutup sementara)</option>
                            </select>
                            <button class="btn btn-info" onclick="updateStatus()" style="white-space: nowrap;">
                                <i class="fas fa-save"></i> Simpan Status
                            </button>
                        </div>
                        <div id="status-indicator" class="status-indicator">
                            <i class="fas fa-circle" style="color: #28a745;"></i> 
                            <span id="status-text">Aktif</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-box">
                    <h5><i class="fas fa-info-circle"></i> Informasi:</h5>
                    <ul style="margin: 10px 0 0 20px; color: #555;">
                        <li>Ubah token akan mengupdate semua data terkait (soal, nilai, session)</li>
                        <li>Status "Nonaktif" akan menutup akses siswa untuk ujian</li>
                        <li>Status "Aktif" akan membuka akses siswa untuk ujian</li>
                        <li>Pastikan token unik dan tidak duplikat dengan ujian lain</li>
                    </ul>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="location.reload()">Batal</button>
                <button class="btn btn-success" onclick="uploadData()" style="flex: 2;">
                    <i class="fas fa-database"></i> Simpan Database
                </button>
            </div>
        </div>
    </div>

    <div id="loading-modal">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p id="progress-text" style="margin-top: 20px;">Menyambung ke server...</p>
        <div class="progress-container"><div class="progress-fill" id="progress-fill"></div></div>
    </div>

    <script>
        const API_URL = "https://ujian-baru.kurikulum-sman2cikarangbarat.workers.dev";
        let adminToken = "";
        let currentToken = "";
        let isEditMode = false;

        // Auto-login jika token sudah ada di session
        if (sessionStorage.getItem('adminToken')) {
            adminToken = sessionStorage.getItem('adminToken');
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
        }

        function attemptLogin() {
            const pass = document.getElementById('admin-password').value;
            if (!pass) return;
            
            // Simpan sementara untuk testing akses
            adminToken = pass;
            checkAdminAccess();
        }

        async function checkAdminAccess() {
            showLoading("Memverifikasi token...");
            try {
                // Sekarang endpoint login adalah /api/admin/login dengan method POST
                const res = await fetch(`${API_URL}/api/admin/login`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Admin-Token': adminToken 
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin'
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok || !data.success) {
                    throw new Error(data.error || "Token Admin Salah!");
                }

                sessionStorage.setItem('adminToken', adminToken);
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
            } catch (e) {
                document.getElementById('login-notif').innerHTML = `<div class="notification notification-error">${e.message}</div>`;
            } finally {
                hideLoading();
            }
        }

        function logout() {
            sessionStorage.removeItem('adminToken');
            location.reload();
        }

        function createNewExam() {
            const t = document.getElementById('input-token').value.trim().toUpperCase();
            if (t.length < 3) return alert("Token minimal 3 karakter");
            
            currentToken = t;
            isEditMode = false;
            
            // Update display
            document.getElementById('display-token').textContent = t;
            document.getElementById('mode-text').textContent = "BUAT UJIAN BARU";
            document.getElementById('setup-step').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            // Update pengaturan lanjutan
            updateUjianDisplay(t, 1); // Default status aktif
            
            // Reset form
            document.getElementById('input-mapel').value = '';
            document.getElementById('input-guru').value = '';
            document.getElementById('input-durasi').value = '90';
            document.getElementById('input-jml-soal').value = '';
            document.getElementById('input-soal').value = '';
            updateSoalCount();
        }

        // Fungsi update tampilan ujian
        function updateUjianDisplay(token, status = 1) {
            currentToken = token;
            document.getElementById('current-token-display').textContent = token;
            document.getElementById('ujian-status').value = status;
            
            // Update status indicator
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const icon = indicator.querySelector('i');
            
            if (status == 1) {
                indicator.style.display = 'block';
                indicator.style.background = '#d4edda';
                indicator.style.border = '1px solid #c3e6cb';
                icon.style.color = '#28a745';
                statusText.textContent = 'Status: Aktif';
            } else {
                indicator.style.display = 'block';
                indicator.style.background = '#f8d7da';
                indicator.style.border = '1px solid #f5c6cb';
                icon.style.color = '#dc3545';
                statusText.textContent = 'Status: Nonaktif';
            }
        }

        // Fungsi update token
        async function updateToken() {
            const newToken = document.getElementById('new-token').value.trim().toUpperCase();
            
            if (!newToken || newToken === currentToken) {
                return alert('Token baru harus berbeda dari token lama!');
            }
            
            if (newToken.length < 3) {
                return alert('Token minimal 3 karakter');
            }
            
            if (!confirm(`Apakah Anda yakin ingin mengubah token dari "${currentToken}" ke "${newToken}"?\n\nSemua data terkait (soal, nilai, session) akan diupdate.`)) {
                return;
            }
            
            showLoading('Mengupdate token...');
            
            try {
                const res = await fetch(`${API_URL}/api/admin/ujian`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_token: currentToken,
                        token: newToken,
                        mapel: document.getElementById('input-mapel').value.trim(),
                        nama_guru: document.getElementById('input-guru').value.trim(),
                        durasi: parseInt(document.getElementById('input-durasi').value),
                        jml_soal: parseInt(document.getElementById('input-jml-soal').value),
                        status: parseInt(document.getElementById('ujian-status').value)
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Gagal mengupdate token');
                }
                
                // Update tampilan
                updateUjianDisplay(newToken, document.getElementById('ujian-status').value);
                document.getElementById('display-token').textContent = newToken;
                document.getElementById('new-token').value = '';
                
                alert('Token berhasil diubah!');
                
                // Refresh data soal jika dalam mode edit
                if (isEditMode) {
                    await loadExistingData(newToken);
                }
                
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // Fungsi update status
        async function updateStatus() {
            const status = document.getElementById('ujian-status').value;
            const statusText = status == 1 ? 'Aktif' : 'Nonaktif';
            
            if (!currentToken) {
                return alert('Token belum dipilih!');
            }
            
            if (!confirm(`Ubah status ujian menjadi "${statusText}"?`)) {
                return;
            }
            
            showLoading('Mengupdate status...');
            
            try {
                const res = await fetch(`${API_URL}/api/admin/ujian/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: currentToken,
                        status: parseInt(status)
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Gagal mengupdate status');
                }
                
                // Update tampilan
                updateUjianDisplay(currentToken, status);
                
                alert(`Status berhasil diubah menjadi "${statusText}"`);
                
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function loadExistingData(token = null) {
            const t = token || document.getElementById('input-token').value.trim().toUpperCase();
            if (!t) return;
            
            showLoading("Mengambil data...");
            try {
                const res = await fetch(`${API_URL}/api/admin/get-ujian?token=${t}`);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error || "Ujian tidak ditemukan");

                // Isi form
                document.getElementById('input-mapel').value = data.ujian.mapel || '';
                document.getElementById('input-guru').value = data.ujian.nama_guru || '';
                document.getElementById('input-durasi').value = data.ujian.durasi || 90;
                document.getElementById('input-jml-soal').value = data.ujian.jml_soal || '';
                document.getElementById('input-soal').value = data.soal_text ? data.soal_text.replace(/\|/g, '\t') : '';
                
                // Set mode dan token
                currentToken = t;
                isEditMode = true;
                
                // Update display
                document.getElementById('display-token').textContent = t;
                document.getElementById('mode-text').textContent = "MODE EDIT";
                document.getElementById('setup-step').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
                // Update pengaturan lanjutan
                // Gunakan status jika ada, jika tidak gunakan aktif (backward compatibility)
                const status = data.ujian.status !== undefined ? data.ujian.status : (data.ujian.aktif || 1);
                updateUjianDisplay(t, status);
                updateSoalCount();
                
            } catch (e) {
                alert(e.message);
            } finally { 
                hideLoading(); 
            }
        }

        function updateSoalCount() {
            const text = document.getElementById('input-soal').value.trim();
            const count = text ? text.split('\n').length : 0;
            document.getElementById('soal-count').textContent = `${count} soal`;
        }

        async function uploadData() {
            const soalRaw = document.getElementById('input-soal').value.trim();
            const mapel = document.getElementById('input-mapel').value.trim();
            const guru = document.getElementById('input-guru').value.trim();
            const jml = document.getElementById('input-jml-soal').value;
            const durasi = document.getElementById('input-durasi').value;
            const status = document.getElementById('ujian-status').value;

            if (!currentToken) return alert("Token belum ditentukan!");
            if (!soalRaw || !mapel || !guru || !jml || !durasi) {
                return alert("Lengkapi semua data: mapel, guru, durasi, jumlah soal, dan soal!");
            }

            const lines = soalRaw.split('\n');
            showLoading("Menyimpan Metadata...");
            document.getElementById('progress-fill').style.width = '10%';

            try {
                // Debug: Tampilkan data yang akan dikirim
                console.log("Data ujian yang akan dikirim:", {
                    token: currentToken,
                    mapel: mapel,
                    nama_guru: guru,
                    durasi: parseInt(durasi),
                    jml_soal: parseInt(jml),
                    status: parseInt(status)
                });

                // 1. Simpan Ujian
                const uRes = await fetch(`${API_URL}/api/admin/ujian`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: currentToken,
                        mapel: mapel,
                        nama_guru: guru,
                        durasi: parseInt(durasi),
                        jml_soal: parseInt(jml),
                        status: parseInt(status)
                    })
                });
                
                const uData = await uRes.json();
                console.log("Response simpan ujian:", uData);
                
                if (!uRes.ok) {
                    throw new Error(uData.error || `Gagal simpan metadata ujian (Status: ${uRes.status})`);
                }

                // 2. Jika edit, hapus soal lama
                if (isEditMode) {
                    console.log("Mode edit: Menghapus soal lama...");
                    await fetch(`${API_URL}/api/admin/soal`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            token: currentToken, 
                            DELETE_OLD: true, 
                            soal: "DEL" 
                        })
                    });
                }

                // 3. Upload Soal
                console.log(`Mulai upload ${lines.length} soal...`);
                let soalSukses = 0;
                for (let i = 0; i < lines.length; i++) {
                    const c = lines[i].split('\t');
                    if (c.length < 7) {
                        console.warn(`Baris ${i+1} diabaikan: format tidak valid`, c);
                        continue;
                    }

                    const soalData = {
                        token: currentToken,
                        soal: c[0].trim(), 
                        opsi_a: c[1].trim(), 
                        opsi_b: c[2].trim(),
                        opsi_c: c[3].trim(), 
                        opsi_d: c[4].trim(), 
                        opsi_e: c[5] ? c[5].trim() : "",
                        kunci: c[6].trim().toUpperCase(), 
                        img_link: c[7] ? c[7].trim() : "",
                        aktif: 1
                    };
                    
                    console.log(`Upload soal ${i+1}:`, soalData);

                    const sRes = await fetch(`${API_URL}/api/admin/soal`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(soalData)
                    });
                    
                    const sData = await sRes.json();
                    
                    if (!sRes.ok) {
                        throw new Error(`Gagal upload soal baris ${i+1}: ${sData.error || 'Error server'}`);
                    }
                    
                    soalSukses++;
                    let pct = 10 + Math.round(((i + 1) / lines.length) * 90);
                    document.getElementById('progress-fill').style.width = pct + '%';
                    document.getElementById('progress-text').textContent = `Mengunggah Soal: ${i+1}/${lines.length}`;
                }
                
                alert(`Sukses! Data telah diperbarui.\n\nTotal soal: ${soalSukses}/${lines.length}`);
                location.reload();
            } catch (e) {
                console.error("Upload error details:", e);
                alert(`ERROR: ${e.message}\n\nCoba buka console (F12) untuk detail.`);
            } finally { 
                hideLoading(); 
            }
        }

        function showLoading(msg) {
            document.getElementById('progress-text').textContent = msg;
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('loading-modal').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-modal').style.display = 'none';
        }

        // Fungsi bantu untuk validasi
        function validateTokenFormat(token) {
            return token && token.length >= 3 && token.length <= 50 && /^[a-zA-Z0-9_-]+$/.test(token);
        }
    </script>
</body>
</html>
